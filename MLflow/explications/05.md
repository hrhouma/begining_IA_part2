# 0 - Nouveaux ajouts par rapport au script prÃ©cÃ©dent ğŸ’€ğŸš¨

Dans cette version, nous avons ajoutÃ© **de nouvelles fonctionnalitÃ©s** pour amÃ©liorer la gestion et le suivi des exÃ©cutions dans MLflow :

ğŸ’€ğŸš¨ **CrÃ©ation et gestion de lâ€™expÃ©rience avec `mlflow.set_experiment()`** : La mÃ©thode `mlflow.set_experiment()` est utilisÃ©e pour dÃ©finir une nouvelle expÃ©rience appelÃ©e `"experiment_2"`. Cette expÃ©rience est suivie dans MLflow et affiche ses informations de configuration (nom, identifiant, emplacement des artefacts, tags et Ã©tapes de cycle de vie).

ğŸ’€ğŸš¨ **Utilisation de `mlflow.start_run()` et `mlflow.end_run()`** : `mlflow.start_run()` dÃ©marre une nouvelle exÃ©cution sans utiliser `experiment_id` directement. `mlflow.end_run()` termine lâ€™exÃ©cution actuelle, facilitant la gestion des exÃ©cutions en cours.

ğŸ’€ğŸš¨ **RÃ©cupÃ©ration de l'exÃ©cution active avec `mlflow.last_active_run()`** : Cette commande permet dâ€™obtenir lâ€™ID et le nom de lâ€™exÃ©cution la plus rÃ©cente, ce qui est utile pour suivre l'exÃ©cution et effectuer un diagnostic rapide.

ğŸ’€ğŸš¨ **Nouveau modÃ¨le enregistrÃ© avec `mlflow.sklearn.log_model(lr, "my_new_model_1")`** : Nous avons ajoutÃ© un nouveau nom `"my_new_model_1"` pour diffÃ©rencier le modÃ¨le dans MLflow et amÃ©liorer lâ€™organisation des artefacts.

Ces ajouts facilitent le suivi et la gestion des expÃ©riences avec des exÃ©cutions nommÃ©es et identifiables, en apportant plus de flexibilitÃ© dans le travail collaboratif et l'organisation des modÃ¨les.

---

# 1 - Script ğŸ›ï¸

Ce script Python utilise le modÃ¨le ElasticNet pour prÃ©dire la qualitÃ© du vin et gÃ¨re une nouvelle expÃ©rience dans MLflow avec des exÃ©cutions nommÃ©es et des artefacts personnalisÃ©s.

```python
# Importation des bibliothÃ¨ques nÃ©cessaires
import warnings  # âš ï¸ Pour gÃ©rer les avertissements dans le programme
import argparse  # ğŸ“ Pour gÃ©rer les arguments de la ligne de commande
import logging  # ğŸ› ï¸ Pour gÃ©rer les messages de journalisation
import pandas as pd  # ğŸ§® Pour manipuler les donnÃ©es sous forme de DataFrame
import numpy as np  # ğŸ”¢ Pour les calculs numÃ©riques, notamment les matrices
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score  # ğŸ“Š Pour les mÃ©triques d'Ã©valuation
from sklearn.model_selection import train_test_split  # ğŸ“š Pour diviser les donnÃ©es en ensembles d'entraÃ®nement et de test
from sklearn.linear_model import ElasticNet  # ğŸ“ˆ Pour utiliser le modÃ¨le de rÃ©gression ElasticNet
import mlflow  # ğŸ’€ğŸš¨ Pour configurer et gÃ©rer le suivi des expÃ©riences
import mlflow.sklearn  # ğŸ’€ğŸš¨ Pour enregistrer des modÃ¨les scikit-learn dans MLflow
from pathlib import Path  # ğŸ’€ğŸš¨ Pour gÃ©rer les chemins d'accÃ¨s des artefacts

# Configuration de la journalisation pour ignorer les messages de niveau infÃ©rieur Ã  "WARNING"
logging.basicConfig(level=logging.WARN)
logger = logging.getLogger(__name__)

# Initialisation d'un analyseur d'arguments pour la ligne de commande
parser = argparse.ArgumentParser()
parser.add_argument("--alpha", type=float, required=False, default=0.7)  # âš™ï¸ Argument "alpha" pour ElasticNet, par dÃ©faut 0.7
parser.add_argument("--l1_ratio", type=float, required=False, default=0.7)  # âš™ï¸ Argument "l1_ratio" pour ElasticNet, par dÃ©faut 0.7
args = parser.parse_args()  # ğŸ› ï¸ Analyse des arguments fournis

# Fonction pour Ã©valuer les performances du modÃ¨le avec plusieurs mÃ©triques
def eval_metrics(actual, pred):
    rmse = np.sqrt(mean_squared_error(actual, pred))  # ğŸ§® Calcul de l'erreur quadratique moyenne (RMSE)
    mae = mean_absolute_error(actual, pred)  # ğŸ§® Calcul de l'erreur absolue moyenne (MAE)
    r2 = r2_score(actual, pred)  # ğŸ“Š Calcul du score RÂ², qui mesure la prÃ©cision du modÃ¨le
    return rmse, mae, r2  # â¡ï¸ Retourne les trois mÃ©triques

# Code principal du programme
if __name__ == "__main__":
    warnings.filterwarnings("ignore")  # âš ï¸ Ignore les avertissements
    np.random.seed(40)  # ğŸ² Fixe la graine alÃ©atoire pour des rÃ©sultats reproductibles

    # Lecture des donnÃ©es depuis le fichier CSV "red-wine-quality.csv" (local)
    data = pd.read_csv("red-wine-quality.csv")

    # Division des donnÃ©es en ensembles d'entraÃ®nement et de test (75% - 25%)
    train, test = train_test_split(data)

    # DÃ©finition des variables de prÃ©diction et de la cible "quality"
    train_x = train.drop(["quality"], axis=1)  # DonnÃ©es d'entraÃ®nement sans la colonne "quality"
    test_x = test.drop(["quality"], axis=1)  # DonnÃ©es de test sans la colonne "quality"
    train_y = train[["quality"]]  # Valeurs de "quality" pour l'entraÃ®nement
    test_y = test[["quality"]]  # Valeurs de "quality" pour le test

    # RÃ©cupÃ©ration des valeurs des arguments alpha et l1_ratio
    alpha = args.alpha
    l1_ratio = args.l1_ratio

    # ğŸ’€ğŸš¨ Configuration de l'URI de suivi MLflow
    mlflow.set_tracking_uri(uri="")  # â¡ï¸ Indiquer lâ€™URL du serveur de suivi MLflow

    # ğŸ’€ğŸš¨ Affichage de l'URI de suivi pour confirmation
    print("The set tracking URI is ", mlflow.get_tracking_uri())

    # ğŸ’€ğŸš¨ DÃ©finition de l'expÃ©rience MLflow
    exp = mlflow.set_experiment(experiment_name="experiment_2")
    print("Name: {}".format(exp.name))
    print("Experiment_id: {}".format(exp.experiment_id))
    print("Artifact Location: {}".format(exp.artifact_location))
    print("Tags: {}".format(exp.tags))
    print("Lifecycle_stage: {}".format(exp.lifecycle_stage))
    print("Creation timestamp: {}".format(exp.creation_time))

    # ğŸ’€ğŸš¨ DÃ©marrage et fin d'exÃ©cution de l'expÃ©rience
    mlflow.start_run()
    lr = ElasticNet(alpha=alpha, l1_ratio=l1_ratio, random_state=42)
    lr.fit(train_x, train_y)

    # PrÃ©diction des qualitÃ©s pour les donnÃ©es de test
    predicted_qualities = lr.predict(test_x)

    # Ã‰valuation des performances du modÃ¨le avec les mÃ©triques
    (rmse, mae, r2) = eval_metrics(test_y, predicted_qualities)

    # Affichage des rÃ©sultats
    print("ElasticNet model (alpha={:f}, l1_ratio={:f}):".format(alpha, l1_ratio))
    print("  RMSE: %s" % rmse)
    print("  MAE: %s" % mae)
    print("  R2: %s" % r2)

    # Enregistrement des paramÃ¨tres et mÃ©triques dans MLflow
    mlflow.log_param("alpha", alpha)
    mlflow.log_param("l1_ratio", l1_ratio)
    mlflow.log_metric("rmse", rmse)
    mlflow.log_metric("r2", r2)
    mlflow.log_metric("mae", mae)

    # ğŸ’€ğŸš¨ Enregistrement du modÃ¨le avec un nouveau nom
    mlflow.sklearn.log_model(lr, "my_new_model_1")

    # ğŸ’€ğŸš¨ Terminer l'exÃ©cution et rÃ©cupÃ©rer la derniÃ¨re exÃ©cution active
    mlflow.end_run()
    run = mlflow.last_active_run()
    print("Active run id is {}".format(run.info.run_id))
    print("Active run name is {}".format(run.info.run_name))
```

---

Avec ce tutoriel complet, chaque ajout par rapport au script prÃ©cÃ©dent est bien mis en Ã©vidence pour faciliter le suivi et lâ€™apprentissage des nouvelles fonctionnalitÃ©s !
